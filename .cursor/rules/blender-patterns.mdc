---
description: Blender-Specific Patterns and Best Practices
globs: ["**/*.py"]
alwaysApply: true
priority: 4
---

# Blender-Specific Patterns

## Addon Registration and UI Updates

### Register Function Pattern
- Always register in order: `preferences.register()` → `properties.register()` → `ui_main.register()`
- **NEVER call `bpy.ops` operators directly in `register()`** - they require valid context
- Use `bpy.app.timers.register()` for deferred UI updates after registration

### UI Updates on Addon Start
- **NEVER call `bpy.ops` directly in `register()`** - context may be invalid
- UI updates should be handled by panels' `draw()` methods or user-initiated refresh buttons
- Panels can auto-refresh empty lists in their `draw()` methods if needed
- If UI updates are needed on addon start, use `bpy.app.timers.register()` with direct function calls (not operators)

### Operators (operators/)
- Inherit from `bpy.types.Operator`
- Use `bl_idname`, `bl_label`, `bl_description` properties
- Access context: `context.scene`, `context.object`
- Report errors: `self.report({'ERROR'}, "message")`

### UI Panels (ui/)
- Inherit from `bpy.types.Panel`
- Use `bl_idname`, `bl_label`, `bl_space_type`, `bl_region_type`
- Use `@classmethod poll(cls, context)` to control visibility

### Properties (properties/)
- Use `bpy.types.PropertyGroup` for complex properties
- Register in `register()` function
- Use `bpy.props` for property definitions

## File Path Handling

### Blender File Paths
- Use `bpy.data.filepath` to get current blend file path
- Check `if bpy.data.filepath:` before using path
- Use `bpy.path.abspath()` to resolve relative paths
- Use `Path(bpy.data.filepath)` for pathlib operations

### Repository Detection
- Pattern: `repo_path = find_repository(blend_file.parent)`
- Check repository existence before operations
- Initialize repository if needed: `init_repository(project_root)`

## Context Handling

### Safe Context Access
- Always check if context is available: `if bpy.context.scene:`
- Use `bpy.context.temp_override()` for operator context override
- Never assume context exists during `register()` or `unregister()`

### Operator Context
- Operators receive `context` parameter in `execute(self, context)`
- Use `context.scene` for scene properties
- Use `context.active_object` for selected objects
- Use `context.selected_objects` for multiple selections

## Error Handling in Blender

### Operator Errors
- Use `self.report({'ERROR'}, "message")` for user-visible errors
- Return `{'CANCELLED'}` on error
- Return `{'FINISHED'}` on success
- Log errors with `logger.error(..., exc_info=True)`

### Silent Failures
- Use `try/except` with `pass` for non-critical operations
- Example: Cleanup operations that shouldn't break addon load

## Mesh Diff Visualization

### Vertex Color Visualization
- Use vertex colors for diff visualization instead of materials
- When applying diff visualization, switch viewport to vertex color mode: `space.shading.color_type = 'VERTEX'`
- Materials are temporarily hidden when vertex colors are displayed
- Always create vertex color layer with unique name (e.g., "DiffColors")
- Clear vertex colors when clearing diff data

### Diff Computation
- Compute diff between two mesh versions using `compute_mesh_diff()` from `forester.utils.mesh_diff_utils`
- Store diff results in scene properties as dictionary (use `diff.to_dict()`)
- Diff includes geometry changes, material changes, and statistics
- Tolerance-based vertex matching (default: 0.001) for geometry comparison

### Diff Models
- Use `MeshDiff`, `GeometryDiff`, `MaterialDiff`, `DiffStatistics` from `forester.models.mesh_diff`
- Geometry diff tracks: vertices_added, vertices_removed, vertices_modified, vertices_moved, faces_added, faces_removed
- Material diff tracks: properties_changed, textures_added/removed/modified, nodes_added/removed/modified
- Statistics include: counts, percentages, displacement metrics

## Texture Versioning

### Texture Versioning
- Textures are versioned independently from meshes using `Texture` model from `forester.models.texture`
- Use `Texture.from_file()` to create texture from file, automatically saves to storage
- Link textures to commits using `db.link_texture_to_commit(texture_hash, commit_hash, mesh_hash)`
- Textures are stored in `.DFM/objects/textures/{hash[:2]}/{hash[2:]}.{ext}`
- Automatic texture versioning happens during mesh commit creation
- Content-addressable storage with SHA-256 hashing ensures deduplication

### Texture Storage Operations
- Use `ObjectStorage.save_texture()` to save texture data
- Use `ObjectStorage.load_texture()` to load texture (tries multiple extensions)
- Always check if texture exists before saving: `storage.texture_exists(hash)`

### Database Texture Operations
- Use `db.add_texture()` to add texture metadata
- Use `db.get_texture()` to retrieve texture info
- Use `db.link_texture_to_commit()` to associate texture with commit
- Use `db.get_textures_for_commit()` to get all textures in commit

## Mesh Export Operations

### Background Mesh Export
- **Purpose**: Export meshes to .blend files without modifying current project scene
- **Implementation**: Uses subprocess to run Blender in `--background` mode
- **Template File**: `empty_files/empty.blend` - empty Blender file template
- **Script**: `operators/mesh_export_background.py` - background export script
- **Main Function**: `operators/mesh_io.py::_save_mesh_to_blend()` - orchestrates export
- **Helper Function**: `operators/mesh_io.py::get_empty_blend_path()` - locates template

### Export Pattern
```python
# 1. Save mesh data to temporary library (doesn't modify scene)
bpy.data.libraries.write(str(temp_lib_path), data_blocks_to_save, fake_user=True)

# 2. Run background Blender process
subprocess.run([
    bpy.app.binary_path,
    '--background',
    '--python', str(script_path),  # mesh_export_background.py
    '--',
    '--empty_blend', str(empty_blend_path),
    '--output_file', str(output_path),
    '--mesh_name', obj_name,
    '--library_file', str(temp_lib_path),
    '--obj_location', str(x), str(y), str(z),
    '--obj_rotation', str(rx), str(ry), str(rz),
    '--obj_scale', str(sx), str(sy), str(sz)
])
```

### Benefits
- **Scene Stability**: Current project scene is never modified
- **No Restoration**: No need to restore project after commit
- **Reliability**: Better stability and prevents scene corruption
- **Compatibility**: Pattern can be reused for other 3D packages

### Requirements
- `empty_files/empty.blend` must exist in addon directory
- `operators/mesh_export_background.py` must be accessible
- Blender binary path must be available via `bpy.app.binary_path`