# Инструкция по использованию аддона Difference Machine

## Содержание
1. [Установка и первый запуск](#установка-и-первый-запуск)
2. [Основные панели](#основные-панели)
3. [Работа с репозиторием](#работа-с-репозиторием)
4. [Создание коммитов](#создание-коммитов)
5. [Управление ветками](#управление-ветками)
6. [Просмотр истории и восстановление версий](#просмотр-истории-и-восстановление-версий)
7. [Сравнение версий](#сравнение-версий)
8. [Настройки аддона](#настройки-аддона)
9. [Полезные советы](#полезные-советы)

---

## Установка и первый запуск

### Установка
1. Откройте Blender
2. Перейдите в `Edit > Preferences > Extensions`
3. Нажмите `Install...` и выберите папку с аддоном
4. Активируйте аддон в списке расширений

### Первый запуск
1. Сохраните файл `.blend` в папку проекта (например, `File > Save As...`)
2. Откройте боковую панель в 3D Viewport (нажмите `N`)
3. Перейдите на вкладку **"Difference Machine"**

### Инициализация проекта
1. Откройте панель **"Branch Management"**
2. Если репозиторий не инициализирован, нажмите кнопку **"Init Project"**
3. Это создаст папку `.DFM` в директории вашего проекта с базой данных версий

---

## Основные панели

В аддоне три основные панели (доступны во вкладке **Difference Machine** в боковой панели `N`):

### 1. Branch Management (Управление ветками)
- Просмотр списка веток
- Создание, переключение и удаление веток
- Кнопка инициализации проекта (если репозиторий не создан)

### 2. Create Commit (Создание коммитов)
- Создание коммитов для выбранных объектов
- Создание полных коммитов проекта
- Настройка экспорта компонентов

### 3. Load Commit (Загрузка коммитов)
- Просмотр истории коммитов
- Восстановление версий мешей
- Сравнение версий
- Удаление коммитов

---

## Работа с репозиторием

### Требования
- **Важно**: Файл `.blend` должен быть сохранен на диск
- Репозиторий автоматически инициализируется при первом коммите или при нажатии **"Init Project"**

### Структура репозитория
После инициализации в папке проекта создается:
- `.DFM/` - папка с данными версий
  - `forester.db` - база данных SQLite с метаданными
  - `objects/` - хранилище объектов (коммиты, деревья, блобы, меши)
  - `refs/branches/` - ссылки на ветки
  - `preview_temp/` - временные файлы для предпросмотра (автоматически очищаются)

---

## Создание коммитов

### Коммит выбранных объектов (Mesh-only Commit)

**Когда использовать:**
- Когда нужно сохранить только изменения конкретных мешей
- Для быстрых промежуточных сохранений версий моделей
- Когда работаете только с геометрией и материалами

**Как создать:**
1. Выберите один или несколько объектов-мешей в сцене
2. Откройте панель **"Create Commit"**
3. Выберите режим **"Selected Object"**
4. Настройте экспорт компонентов:
   - **Export All Components** - экспортировать все компоненты
   - Или выберите отдельно:
     - **Geometry** - геометрия (вершины, грани)
     - **Materials** - материалы и ноды
     - **Transform** - трансформации объекта
     - **UV Layout** - UV-развертки
5. Введите сообщение коммита (например: "Добавил детали на меч")
6. Нажмите **"Create Commit"**
   - Поле сообщения автоматически очищается после успешного создания коммита

**Особенности:**
- Коммит сохраняет только выбранные объекты, их материалы и текстуры
- Остальные объекты сцены не сохраняются в этом коммите
- Можно создать несколько коммитов для разных объектов

### Полный коммит проекта (Full Project Commit)

**Когда использовать:**
- Когда нужно сохранить весь проект целиком
- Для важных вех разработки
- Когда нужно сделать резервную копию всего проекта

**Как создать:**
1. Откройте панель **"Create Commit"**
2. Выберите режим **"Full Project"**
3. Введите сообщение коммита
4. Нажмите **"Create Commit"**
   - Поле сообщения автоматически очищается после успешного создания коммита

**Особенности:**
- Сохраняет все файлы проекта (`.blend` файлы, текстуры, и т.д.)
- Создает полный снимок состояния проекта
- Можно использовать для восстановления всего проекта из коммита

---

## Управление ветками

### Просмотр веток
1. Откройте панель **"Branch Management"**
2. Нажмите **"Refresh Branches"** для обновления списка
3. В списке отображается:
   - Название ветки
   - Количество коммитов
   - Последний коммит и его сообщение
   - Текущая ветка помечена специальным индикатором

### Создание новой ветки
1. В панели **"Branch Management"** нажмите **"Create New Branch"**
2. Введите название ветки в диалоговом окне
3. Новая ветка будет создана от текущей

**Использование веток:**
- Создавайте отдельные ветки для разных вариантов модели
- Например: `main`, `v2-detail`, `low-poly`, `texture-variants`
- Ветки позволяют параллельно работать над разными версиями

### Переключение между ветками
1. Выберите ветку из списка
2. Нажмите **"Switch Branch"**
3. Blender переключится на эту ветку (HEAD обновится)

**Важно:** 
- При переключении веток рабочая директория обновляется
- Несохраненные изменения могут быть потеряны

### Удаление ветки
1. Выберите ветку из списка (не текущую)
2. Нажмите **"Delete Branch"**
3. Подтвердите удаление

**Ограничения:**
- Нельзя удалить текущую ветку
- Нельзя удалить последнюю оставшуюся ветку

---

## Просмотр истории и восстановление версий

### Просмотр истории коммитов
1. Откройте панель **"Load Commit"**
2. Нажмите **"Refresh"** для обновления списка
3. В списке отображаются все коммиты текущей ветки:
   - Хеш коммита
   - Сообщение
   - Автор
   - Дата создания
   - Тип коммита (project или mesh_only)
   - Для mesh-only: подробная информация о всех мешах в коммите
     - Имя объекта (кликабельно - клик выбирает объект во вьюпорте)
     - Количество вершин
     - Количество граней

### Восстановление меша из коммита (Mesh-only)

**Просмотр информации о мешах:**
- При выборе коммита типа `mesh_only` в панели отображается подробная информация о всех мешах в коммите:
  - Имя объекта (кликабельно - клик по имени выбирает объект во вьюпорте)
  - Количество вершин
  - Количество граней
- Это помогает быстро определить, какие меши включены в коммит

**Вариант 1: Replace Mesh (Заменить текущий меш)**
1. Выберите меш в сцене (должен совпадать с именем меша в коммите)
2. Выберите коммит в списке
3. Нажмите **"Replace This Mesh"**
4. Текущий меш будет заменен версией из коммита

**Вариант 2: Compare (Сравнение)**
- См. раздел [Сравнение версий](#сравнение-версий)

**Быстрый выбор объекта:**
- Кликните на имя любого меша в деталях коммита, чтобы автоматически выбрать этот объект во вьюпорте

### Восстановление проекта (Full Project Commit)

**Checkout to Working Directory:**
1. Выберите коммит типа "project" в списке
2. Нажмите **"Checkout to Working Directory"**
3. Все файлы проекта будут восстановлены из коммита

**Open Project State:**
1. Выберите коммит типа "project"
2. Нажмите **"Open Project"**
3. Blender откроет `.blend` файл из рабочей директории после checkout

**Важно:**
- Эти операции обновляют рабочую директорию
- Несохраненные изменения будут потеряны

### Удаление коммита
1. Выберите коммит в списке
2. Нажмите **"Delete This Version"**
3. Подтвердите удаление

**Ограничения:**
- Коммиты, на которые ссылаются ветки, защищены от удаления
- Удаление коммита не удаляет физические файлы (используйте Garbage Collection)

---

## Сравнение версий

### Сравнение мешей (Mesh Comparison)

**Как использовать:**
1. Выберите меш в сцене (должен совпадать с именем в коммите)
2. Выберите коммит типа "mesh_only" в списке
3. Нажмите **"Compare"**
4. В сцене появится объект сравнения с версией из коммита

**Управление сравнением:**
- **Кнопки осей (X, Y, Z)**: Изменяют смещение объекта сравнения по выбранной оси
- **Кнопка "Compare"**: Повторное нажатие удаляет объект сравнения

**Режим сравнения:**
- Когда объект сравнения активен, другие операции (коммиты, ветки) недоступны
- Доступны только просмотр и изменение оси смещения

### Сравнение проектов (Project Comparison)

**Как использовать:**
1. Выберите коммит типа "project" в списке
2. Нажмите **"Compare"**
3. Коммит будет скопирован во временную папку и открыт в новом окне Blender

**Управление:**
- Повторное нажатие **"Compare"** закрывает окно сравнения
- Изменения в окне сравнения не сохраняются автоматически

---

## Настройки аддона

Доступны через `Edit > Preferences > Extensions > Difference Machine`

### Commit Settings (Настройки коммитов)
- **Default Author**: Имя автора по умолчанию для всех коммитов

### Auto-compress Settings (Автосжатие)
- **Auto-compress Mesh-only Commits**: Автоматически удалять старые mesh-only коммиты
- **Keep Last N Commits**: Сколько последних коммитов оставлять (по умолчанию 5)

**Когда использовать:**
- Если создаете много промежуточных версий мешей
- Для экономии места на диске
- Включите, если уверены, что старые версии не нужны

### Garbage Collection (Сборка мусора)

**Ручная сборка:**
- **Garbage Collect Now**: Удалить все неиспользуемые объекты
- **Dry Run (Preview)**: Предпросмотр того, что будет удалено (без фактического удаления)

**Автоматическая сборка:**
- Включите **"Auto Garbage Collect"**
- Настройте интервал (часы/дни/недели)
- Сборка будет запускаться автоматически

**Что удаляется:**
- Коммиты, не используемые ветками
- Деревья, блобы и меши, не связанные с коммитами
- Защищены: объекты, на которые ссылаются ветки и стэши

### Database Maintenance (Обслуживание базы данных)
- **Rebuild Database**: Восстановить базу данных из файлов хранилища
- Используйте, если база данных повреждена или потеряна

---

## Полезные советы

### Рабочий процесс
1. **Инициализируйте проект** перед началом работы
2. **Сохраняйте файл** перед любыми операциями
3. **Используйте ветки** для экспериментов и вариантов
4. **Создавайте mesh-only коммиты** для быстрых сохранений геометрии
5. **Создавайте project коммиты** для важных вех
6. **Регулярно запускайте Garbage Collection** для очистки

### Оптимизация размера репозитория
- Включите **Auto-compress** для mesh-only коммитов
- Настройте **Auto Garbage Collect**
- Регулярно удаляйте ненужные коммиты и ветки

### Безопасность
- **Не удаляйте коммиты**, на которые ссылаются ветки
- Перед важными изменениями создайте **backup ветку**
- Используйте **Dry Run** перед Garbage Collection

### Текстуры
- Аддон автоматически отслеживает текстуры
- Измененные текстуры копируются в коммит
- Неизмененные текстуры ссылаются на предыдущие версии (дедупликация)

### CLI (Командная строка)
Для продвинутых пользователей доступна командная строка `forester`:
- `forester show <hash>` - просмотр изменений в коммите
- `forester log` - история коммитов
- `forester branch` - управление ветками
- Подробнее см. README.md

---

## Часто задаваемые вопросы

**Q: Где хранятся данные версий?**  
A: В папке `.DFM` в корне проекта. База данных - `forester.db`, объекты - в `objects/`.

**Q: Можно ли переместить проект?**  
A: Да, просто скопируйте всю папку проекта с `.DFM`. Аддон найдет репозиторий автоматически.

**Q: Что делать, если база данных повреждена?**  
A: Используйте **Rebuild Database** в настройках аддона.

**Q: Как удалить репозиторий?**  
A: Просто удалите папку `.DFM` в проекте. Можно начать заново с **Init Project**.

**Q: Работает ли аддон с несколькими файлами .blend в одном проекте?**  
A: Да, project коммиты сохраняют все файлы проекта, а mesh-only коммиты работают с конкретным файлом.

**Q: Можно ли использовать с Git?**  
A: Да, но рекомендуется добавить `.DFM/` в `.gitignore`, так как это большой бинарный репозиторий версий Blender.

---

## Поддержка

Если у вас возникли проблемы или вопросы:
- Проверьте, что файл `.blend` сохранен
- Убедитесь, что репозиторий инициализирован
- Используйте кнопку **"Refresh"** для обновления списков
- Проверьте логи (если доступны в консоли Blender)

Автор: Dmitry Litvinov <nopomuk@yandex.ru>